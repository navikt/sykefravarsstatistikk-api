apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: sykefravarsstatistikk-api-alert
  namespace: teamia
  labels:
    team: teamia
spec:
  groups:
    - name: sykefravarsstatistikk-api-alerts
      rules:
      - alert: ApplikasjonOppeTest
        expr: sum(up{container="sykefravarsstatistikk-api"}) > 0
        for: 2m
        annotations:
          consequence: "Sykefravarsstatistikk-api er ekstremt tilgjengelig"
          action: |-
            Ikke sjekk helsa til applikasjonen ved å kjøre
            `kubectl describe pod <podname> -n teamia` og 
            `kubectl logs <podname> -n teamia`"
        labels:
          namespace: teamia
          severity: good

      - alert: ApplikasjonNede
        expr: sum(up{container="sykefravarsstatistikk-api"}) == 0
        for: 2m
        annotations:
          consequence: "Sykefravarsstatistikk-api er utilgjengelig"
          action: |-
            Sjekk helsa til applikasjonen ved å kjøre
            `kubectl describe pod <podname> -n teamia` og 
            `kubectl logs <podname> -n teamia`"
        labels:
          namespace: teamia
          severity: critical

      - alert: ErrorLogRegistrert
        expr: sum(increase(logd_messages_total{log_app="sykefravarsstatistikk-api",log_level="Error"}[10m])) > 0
        annotations:
          description: "Sykefravarsstatistikk-api har logget en (eller flere) feil."
          action: |-
            Sjekk logs.adeo.no for logger, 
            eller Grafana-dashboardet vårt: https://grafana.nais.io/dashboards/f/cvOhCMUnz/team-ia
        labels:
          namespace: teamia
          severity: warning

      - alert: ImportVellykket
        expr: sum(increase(sykefravarstatistikk_vellykket_import_total{app="sykefravarsstatistikk-api"}[10m])) > 0
        annotations:
          description: "Import av sykefraværsstatistikk var vellykket"
          action: "Sjekk at appene oppfører seg som de skal. Nyt deretter en kopp kaffe!"
        labels:
          namespace: teamia
          severity: good