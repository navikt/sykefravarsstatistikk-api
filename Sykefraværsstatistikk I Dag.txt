title Sykefraværsstatistikk I Dag

actor Utvikler
participant sykefraversstatiskk-api
database agg_ia_sykefravar_v_2 #red
database sykefravar_statistikk_virksomhet_med_gradering

//Eksisterende tabeller
database virksomhet_metadata
database virksomhet_metadata_naring_kode_5siffer
database eksport_per_kvartal
database kafka_utsending_historikk
database virksomheter_bekreftet_eksportert
control kafka

== Reimporter virksomhetsdata ==
activate Utvikler
Utvikler->sykefraversstatiskk-api: POST /reimportVirksomhetMetadata
activate sykefraversstatiskk-api

sykefraversstatiskk-api->agg_ia_sykefravar_v_2: Henter virksomhet metadata
sykefraversstatiskk-api->virksomhet_metadata: Tøm tabell
sykefraversstatiskk-api->virksomhet_metadata: Opprett virksomhetdata

sykefraversstatiskk-api->sykefravar_statistikk_virksomhet_med_gradering: Henter næringskode
sykefraversstatiskk-api->virksomhet_metadata_naring_kode_5siffer: Tøm tabell
sykefraversstatiskk-api->virksomhet_metadata_naring_kode_5siffer: Opprett virksomhetsdata
sykefraversstatiskk-api-->Utvikler:

deactivate sykefraversstatiskk-api
deactivate Utvikler

== Forbered neste eksport ==

activate Utvikler
Utvikler->sykefraversstatiskk-api: POST /forberedNesteEksport
activate sykefraversstatiskk-api
alt Slett historikk parameter er true
note over kafka_utsending_historikk: Data:\norgnummer\nkey (orgnummer, årstall, kvartal)\nvalue (sykefraværsstatistikk)
sykefraversstatiskk-api->kafka_utsending_historikk: Tøm tabell
end
sykefraversstatiskk-api->eksport_per_kvartal: Hent antall ikke ferdig eksporter (fra siste eksport)

alt Det finnes ikke eksportert
sykefraversstatiskk-api-->Utvikler: Utvikler må fullføre forrige eksport
end

sykefraversstatiskk-api->eksport_per_kvartal: Tøm tabell
sykefraversstatiskk-api->virksomhet_metadata: Hent metadata for forespurte årsratll og kvartal
sykefraversstatiskk-api->virksomhet_metadata_naring_kode_5siffer: Hent metadata for forespurte årsratll og kvartal
sykefraversstatiskk-api->sykefraversstatiskk-api: Slå sammen metadata fra begge kildene

sykefraversstatiskk-api->eksport_per_kvartal: Putter inn alle orgnummer som skal eksporteres
sykefraversstatiskk-api-->Utvikler:
deactivate sykefraversstatiskk-api
deactivate Utvikler

== Start eksport ==

activate Utvikler
Utvikler->sykefraversstatiskk-api: POST /eksportering/reeksport
activate sykefraversstatiskk-api
sykefraversstatiskk-api->eksport_per_kvartal: Henter alle orgnummer som skal eksporteres
sykefraversstatiskk-api->sykefraversstatiskk-api: Filtrer ut orgnummer som\nallerede er eksportert
sykefraversstatiskk-api->virksomhet_metadata: Hent metadata for kvartal
sykefraversstatiskk-api->sykefraversstatiskk-api: Henter all statistikk fra våre databaser
sykefraversstatiskk-api->kafka: Publiser all statististikk og metadata til gammel topic
sykefraversstatiskk-api->virksomheter_bekreftet_eksportert: Legg inn alle virksomheter som har fått eksportert statistikk
sykefraversstatiskk-api->eksport_per_kvartal: Marker alle som er eksportert
sykefraversstatiskk-api->virksomheter_bekreftet_eksportert: Tøm tabell
sykefraversstatiskk-api->sykefraversstatiskk-api: Logger rapport om Kafka utsendingen
sykefraversstatiskk-api-->Utvikler:
deactivate sykefraversstatiskk-api
deactivate Utvikler
